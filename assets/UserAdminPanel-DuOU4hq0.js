import{j as e,r as m,p as J}from"./index-CKf_xS9t.js";function Z({user_id:n,topic_id:c,existingContext:r,existingAnswer:f,topic:x,editedContextFields:w,setEditedContextFields:u,cancelEdit:g,saveEdit:y}){var v,C;const p=((v=w[n])==null?void 0:v[c])||{reasoning:(r==null?void 0:r.reasoning)||"",sources:((C=r==null?void 0:r.sources)==null?void 0:C.join(`
`))||"",value:(f==null?void 0:f.value)??null},j=(i,O)=>{u(P=>{var T;return{...P,[n]:{...P[n],[c]:{...(T=P[n])==null?void 0:T[c],[i]:O}}}})};return e.jsxs("div",{className:"flex flex-col gap-4 mt-2 mx-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Stance Selection:"}),e.jsxs("select",{className:"border px-2 py-1 rounded w-full",value:p.value??"",onChange:i=>j("value",parseInt(i.target.value)),children:[e.jsx("option",{value:"",disabled:!0,children:"Select a stance"}),(x.stances||[]).map(i=>e.jsxs("option",{value:i.value,children:[i.value,". ",i.text]},i.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Reasoning:"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",rows:4,value:p.reasoning,onChange:i=>j("reasoning",i.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Sources (one per line):"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",rows:4,value:p.sources,onChange:i=>j("sources",i.target.value)})]}),e.jsxs("div",{className:"flex justify-center gap-3 my-2",children:[e.jsx("button",{className:"border px-4 py-2 rounded hover:bg-gray-100",onClick:g,children:"Cancel"}),e.jsx("button",{className:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",onClick:()=>y(p.value),children:"Save"})]})]})}function I(n){var r;const c=n.context;if(c)return e.jsxs("div",{className:"flex flex-col gap-4 bg-white p-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Reasoning:"}),c.reasoning?e.jsx("div",{className:"whitespace-pre-wrap text-base leading-relaxed ml-1",children:c.reasoning}):e.jsx("p",{className:"ml-1 italic text-gray-400",children:"No reasoning provided."})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Sources:"}),(r=c.sources)!=null&&r.length?e.jsx("ul",{className:"list-disc list-inside ml-1",children:c.sources.map((f,x)=>e.jsx("li",{children:f},x))}):e.jsx("p",{className:"ml-1 italic text-gray-400",children:"No sources provided."})]})]})}function Q({user:n,answer:c,topic:r,context:f,openTopics:x,toggleTopicOpen:w,editingContext:u,setEditingContext:g,editedContextFields:y,setEditedContextFields:p,saveContextEdit:j}){var T;const v=x.includes(r.id),C=(u==null?void 0:u.user_id)===n.user_id&&(u==null?void 0:u.topic_id)===r.id,i=f.find(A=>A.topic_id===r.id),O=()=>{w(r.id)},P=()=>{g({user_id:n.user_id,topic_id:r.id}),v||w(r.id)};return e.jsxs("div",{className:"border rounded mt-2 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between cursor-pointer bg-gray-100 p-4",children:[e.jsx("h3",{onClick:O,className:"font-semibold w-full h-full",children:r.short_title}),e.jsx("button",{onClick:P,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-600 hover:text-black cursor-pointer",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931ZM19.5 7.125 16.862 4.487ZM18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"})})})]}),v&&e.jsxs("div",{className:"mt-2",children:[C?e.jsx(Z,{user_id:n.user_id,topic_id:r.id,topic:r,existingContext:i,editedContextFields:y,setEditedContextFields:p,cancelEdit:()=>g(null),saveEdit:()=>j(n.user_id,r.id)}):e.jsxs("div",{children:[c&&e.jsxs("div",{className:"m-2 bg-gray-100 p-4 rounded",children:[e.jsxs("p",{className:"font-semibold",children:["Answer Value: ",c.value]}),e.jsx("p",{className:"text-gray-700",children:((T=r.stances.find(A=>A.value===c.value))==null?void 0:T.text)||e.jsx("span",{className:"italic text-gray-400",children:"Unknown stance"})})]}),e.jsx(I,{context:i})]}),!i&&!C&&e.jsx("p",{className:"italic text-gray-400 mt-2 ml-1 p-2",children:"No context written for this topic."})]})]})}function Y({user:n,onClose:c,onSave:r,deleteUser:f}){const[x,w]=m.useState({}),[u,g]=m.useState(!1),y=(p,j)=>{w(v=>({...v,[p]:j}))};return console.log("Updated",x),e.jsx("div",{className:"fixed inset-0 backdrop-blur-sm bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl p-6 w-full max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-center",children:n.username}),e.jsxs("div",{className:"flex flex-col gap-2 items-center",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Update Username:"}),e.jsx("input",{className:"border rounded p-1 w-1/2 bg-white",value:x.username,onChange:p=>y("username",p.target.value)})]}),u&&e.jsx("div",{className:"fixed inset-0 backdrop-blur-sm bg-black/30 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-white rounded-xl shadow-xl p-6 w-full max-w-md",children:e.jsxs("div",{className:"flex flex-col gap-6 items-center",children:[e.jsxs("h1",{className:"text-red-600 text-xl font-semibold text-center",children:["Are you sure you want to delete ",n.username,"?"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:"px-4 py-2 bg-red-600 rounded hover:bg-red-500 text-white cursor-pointer",onClick:()=>f(n.user_id),children:"Yes"}),e.jsx("button",{className:"px-4 py-2 bg-gray-200 rounded hover:bg-gray-300  text-black cursor-pointer",onClick:()=>g(!1),children:"No"})]})]})})}),e.jsxs("div",{className:"flex gap-2 mx-4 mt-12 justify-between",children:[e.jsx("div",{children:e.jsx("button",{className:"px-4 py-2 bg-red-600 rounded hover:bg-red-500 text-white cursor-pointer",onClick:()=>{g(!0)},children:"Delete User"})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:c,className:"px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 cursor-pointer",children:"Cancel"}),e.jsx("button",{disabled:!x,onClick:()=>{r(n.user_id,x),c()},className:"px-4 py-2 bg-black text-white rounded disabled:opacity-50 cursor-pointer disabled:cursor-not-allowed justify-end",children:"Update"})]})]})]})})}function q({user:n,answers:c,isOpen:r,toggleOpen:f,context:x,setContext:w,topics:u,openTopics:g,toggleTopicOpen:y,editingContext:p,setEditingContext:j,editedContextFields:v,setEditedContextFields:C,saveContextEdit:i,visibleOnlyWithContext:O,toggleVisibleOnlyWithContext:P,updateUserPic:T,updateUsername:A,updateUserList:W,searchQuery:B,setSearchQuery:D}){const[H,$]=m.useState(!1),[R,F]=m.useState(""),[a,s]=m.useState(!1),l=x[n.user_id]||[],d=t=>{var h,L;return t&&(((h=t.reasoning)==null?void 0:h.trim())||((L=t.sources)==null?void 0:L.length)>0)},o=()=>{s(!1)},_=async(t,h)=>{if(!(await fetch("https://ev-backend-edhm.onrender.com/auth/update-username",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t,username:h.username})})).ok){alert("Failed to update username");return}A(t,h.username)},N=async t=>{if(!(await fetch(`https://ev-backend-edhm.onrender.com/auth/delete-user/${t}`,{method:"DELETE",credentials:"include"})).ok){alert("Failed to delete user.");return}W(t)},E=async(t,h)=>{if(!(await fetch("https://ev-backend-edhm.onrender.com/auth/update-profile-pic",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:h,url:t})})).ok){alert("Failed to update profile picture");return}T(h,t),$(!1)};return e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-100 p-4 cursor-pointer flex justify-between items-center",onClick:f,children:[e.jsxs("div",{className:"relative group w-24 h-24 cursor-pointer",onClick:t=>{t.stopPropagation(),$(!0),F(n.profile_pic_url||"")},children:[e.jsx("img",{src:n.profile_pic_url||J,alt:`${n.username}'s profile`,className:"w-full h-full object-cover rounded-full border shadow"}),e.jsx("div",{className:"absolute inset-0 bg-black/60 hidden group-hover:flex justify-center items-center rounded-full",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"white",className:"size-6",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"})})})]}),H&&e.jsxs("div",{className:"flex flex-col gap-2 mt-2",children:[e.jsx("input",{type:"text",className:"border p-1 rounded",placeholder:"Enter image URL",value:R,onChange:t=>F(t.target.value)}),e.jsxs("div",{className:"flex flex-wrap justify-center gap-4",children:[e.jsx("button",{onClick:t=>{t.stopPropagation(),E(R,n.user_id)},className:"bg-blue-500 text-white px-2 py-1 rounded cursor-pointer hover:bg-blue-700",children:"Save"}),e.jsx("button",{onClick:t=>{t.stopPropagation(),$(!1),F("")},className:"text-gray-500 underline cursor-pointer hover:text-gray-700",children:"Cancel"}),n.profile_pic_url&&e.jsx("button",{onClick:t=>{t.stopPropagation(),F(""),E("",n.user_id)},className:"text-red-500 underline cursor-pointer hover:text-red-700",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"size-6",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"})})})]})]}),e.jsx("h2",{className:"text-xl font-semibold",children:n.username}),e.jsx("div",{onClick:()=>s(!0),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"size-6",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"})})})]}),r&&e.jsxs("div",{className:"p-4 bg-white",children:[e.jsx("input",{type:"text",placeholder:"Search topics...",className:"border px-2 py-1 mb-2 rounded w-full",value:B,onChange:t=>D(t.target.value)}),e.jsxs("label",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"checkbox",checked:O[n.user_id]||!1,onChange:()=>P(n.user_id)}),e.jsx("span",{className:"text-sm",children:"Show only topics with context"})]}),u.filter(t=>{const h=l.find(U=>U.topic_id===t.id),L=t.short_title.toLowerCase().includes(B.toLowerCase()),k=O[n.user_id]?d(h):!0;return L&&k}).map(t=>e.jsx(Q,{user:n,answer:c.find(h=>h.topic_id===t.id),topic:t,context:l,openTopics:g,toggleTopicOpen:y,editingContext:p,setEditingContext:j,editedContextFields:v,setEditedContextFields:C,saveContextEdit:i},t.id))]}),a&&e.jsx(Y,{user:n,onClose:o,onSave:_,deleteUser:N})]})}function K({topics:n}){const[c,r]=m.useState([]),[f,x]=m.useState([]),[w,u]=m.useState({}),[g,y]=m.useState(null),[p,j]=m.useState({}),[v,C]=m.useState({}),[i,O]=m.useState([]),[P,T]=m.useState(!1),[A,W]=m.useState({}),[B,D]=m.useState({}),H=async a=>{if(f.includes(a)){x(s=>s.filter(l=>l!==a));return}try{const s=n.map(o=>o.id),l=await fetch("https://ev-backend-edhm.onrender.com/compass/compare",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:a,ids:s})});if(!l.ok)throw new Error("Failed to fetch answers");const d=await l.json();D(o=>({...o,[a]:d})),x(o=>[...o,a])}catch(s){console.error("Error fetching answers:",s)}},$=a=>{O(s=>s.includes(a)?s.filter(l=>l!==a):[...s,a])},R=a=>{C(s=>({...s,[a]:!s[a]}))},F=async(a,s,l)=>{var t,h,L;const d=(t=p[a])==null?void 0:t[s];if(!d)return;const o=((h=w[a])==null?void 0:h.find(k=>k.topic_id===s))||{},_=d.reasoning!==void 0?d.reasoning:o.reasoning||"",N=(d.sources??((L=o.sources)==null?void 0:L.join(`
`))??"").split(`
`).map(k=>k.trim()).filter(k=>k.length>0),E=l??d.value;try{if(!(await fetch("https://ev-backend-edhm.onrender.com/compass/context",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:a,topic_id:s,reasoning:_,sources:N})})).ok)throw new Error("Failed to save context");await fetch("https://ev-backend-edhm.onrender.com/compass/answers/admin",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:a,topic_id:s,value:E})}),u(U=>{const S=U[a]||[],M=S.map(b=>b.topic_id===s?{...b,reasoning:_,sources:N}:b),V=S.some(b=>b.topic_id===s)?M:[...S,{topic_id:s,reasoning:_,sources:N}];return{...U,[a]:V}}),D(U=>{const S=U[a]||[],M=S.map(b=>b.topic_id===s?{...b,value:E}:b),V=S.some(b=>b.topic_id===s)?M:[...S,{topic_id:s,value:E}];return{...U,[a]:V}}),j(U=>{var M;const S={...U};return(M=S[a])==null||delete M[s],S}),y(null)}catch(k){console.error(k),alert("Failed to save context or answers")}};return m.useEffect(()=>{(async()=>{try{const[s,l]=await Promise.all([fetch("https://ev-backend-edhm.onrender.com/auth/empowered-accounts",{credentials:"include"}),fetch("https://ev-backend-edhm.onrender.com/compass/context",{credentials:"include"})]);if(!s.ok||!l.ok)throw new Error("Fetch failed");const[d,o]=await Promise.all([s.json(),l.json()]);console.log(o);const _=o.reduce((N,E)=>{const t=E.user_id;return N[t]||(N[t]=[]),N[t].push(E),N},{});r(d),u(_)}catch(s){console.error(s),alert("Failed to load admin data")}})()},[]),e.jsxs("div",{className:"w-3/4 mx-auto mt-6 space-y-4",children:[e.jsx("div",{className:"flex flex-col items-center gap-4",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Empowered Users"})}),c.map(a=>e.jsx(q,{user:a,answers:B[a.user_id]||[],isOpen:f.includes(a.user_id),toggleOpen:()=>H(a.user_id),context:w,setContext:u,topics:n,openTopics:i,toggleTopicOpen:$,editingContext:g,setEditingContext:y,editedContextFields:p,setEditedContextFields:j,saveContextEdit:F,visibleOnlyWithContext:v,toggleVisibleOnlyWithContext:R,updateUserPic:(s,l)=>{r(d=>d.map(o=>o.user_id===s?{...o,profile_pic_url:l}:o))},updateUsername:(s,l)=>{r(d=>d.map(o=>o.user_id===s?{...o,username:l}:o))},updateUserList:s=>{r(l=>l.filter(d=>d.user_id!==s))},searchQuery:A[a.user_id]||"",setSearchQuery:s=>W(l=>({...l,[a.user_id]:s}))},a.user_id))]})}export{K as default};
