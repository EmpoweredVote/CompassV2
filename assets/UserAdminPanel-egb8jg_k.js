import{j as e,r as u,p as J}from"./index-qFP0yJ8s.js";function Z({userID:n,topicID:l,existingContext:a,existingAnswer:h,topic:x,editedContextFields:w,setEditedContextFields:d,cancelEdit:b,saveEdit:y}){var g,v;const m=((g=w[n])==null?void 0:g[l])||{reasoning:(a==null?void 0:a.reasoning)||"",sources:((v=a==null?void 0:a.sources)==null?void 0:v.join(`
`))||"",value:(h==null?void 0:h.value)??null},f=(o,N)=>{d(k=>{var S;return{...k,[n]:{...k[n],[l]:{...(S=k[n])==null?void 0:S[l],[o]:N}}}})};return e.jsxs("div",{className:"flex flex-col gap-4 mt-2 mx-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Stance Selection:"}),e.jsxs("select",{className:"border px-2 py-1 rounded w-full",value:m.value??"",onChange:o=>f("value",parseInt(o.target.value)),children:[e.jsx("option",{value:"",disabled:!0,children:"Select a stance"}),(x.stances||[]).map(o=>e.jsxs("option",{value:o.Value,children:[o.Value,". ",o.Text]},o.Value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Reasoning:"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",rows:4,value:m.reasoning,onChange:o=>f("reasoning",o.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Sources (one per line):"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",rows:4,value:m.sources,onChange:o=>f("sources",o.target.value)})]}),e.jsxs("div",{className:"flex justify-center gap-3 my-2",children:[e.jsx("button",{className:"border px-4 py-2 rounded hover:bg-gray-100",onClick:b,children:"Cancel"}),e.jsx("button",{className:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",onClick:()=>y(m.value),children:"Save"})]})]})}function z(n){var a;const l=n.context;if(l)return e.jsxs("div",{className:"flex flex-col gap-4 bg-white p-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Reasoning:"}),l.reasoning?e.jsx("div",{className:"whitespace-pre-wrap text-base leading-relaxed ml-1",children:l.reasoning}):e.jsx("p",{className:"ml-1 italic text-gray-400",children:"No reasoning provided."})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Sources:"}),(a=l.sources)!=null&&a.length?e.jsx("ul",{className:"list-disc list-inside ml-1",children:l.sources.map((h,x)=>e.jsx("li",{children:h},x))}):e.jsx("p",{className:"ml-1 italic text-gray-400",children:"No sources provided."})]})]})}function Q({user:n,answer:l,topic:a,context:h,openTopics:x,toggleTopicOpen:w,editingContext:d,setEditingContext:b,editedContextFields:y,setEditedContextFields:m,saveContextEdit:f}){var S;const g=x.includes(a.ID),v=(d==null?void 0:d.user_id)===n.user_id&&(d==null?void 0:d.topic_id)===a.ID,o=h.find(E=>E.topic_id===a.ID),N=()=>{w(a.ID)},k=()=>{b({user_id:n.user_id,topic_id:a.ID}),g||w(a.ID)};return e.jsxs("div",{className:"border rounded mt-2 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between cursor-pointer bg-gray-100 p-4",children:[e.jsx("h3",{onClick:N,className:"font-semibold w-full h-full",children:a.ShortTitle}),e.jsx("button",{onClick:k,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-600 hover:text-black cursor-pointer",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931ZM19.5 7.125 16.862 4.487ZM18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"})})})]}),g&&e.jsxs("div",{className:"mt-2",children:[v?e.jsx(Z,{userID:n.user_id,topicID:a.ID,topic:a,existingContext:o,editedContextFields:y,setEditedContextFields:m,cancelEdit:()=>b(null),saveEdit:()=>f(n.user_id,a.ID)}):e.jsxs("div",{children:[l&&e.jsxs("div",{className:"m-2 bg-gray-100 p-4 rounded",children:[e.jsxs("p",{className:"font-semibold",children:["Answer Value: ",l.value]}),e.jsx("p",{className:"text-gray-700",children:((S=a.stances.find(E=>E.Value===l.value))==null?void 0:S.Text)||e.jsx("span",{className:"italic text-gray-400",children:"Unknown stance"})})]}),e.jsx(z,{context:o})]}),!o&&!v&&e.jsx("p",{className:"italic text-gray-400 mt-2 ml-1 p-2",children:"No context written for this topic."})]})]})}function q({user:n,answers:l,isOpen:a,toggleOpen:h,context:x,setContext:w,topics:d,openTopics:b,toggleTopicOpen:y,editingContext:m,setEditingContext:f,editedContextFields:g,setEditedContextFields:v,saveContextEdit:o,visibleOnlyWithContext:N,toggleVisibleOnlyWithContext:k,updateUserPic:S,searchQuery:E,setSearchQuery:V}){const[R,U]=u.useState(!1),[A,O]=u.useState(""),F=x[n.user_id]||[],B=s=>{var r,c;return s&&(((r=s.reasoning)==null?void 0:r.trim())||((c=s.sources)==null?void 0:c.length)>0)},t=async(s,r)=>{if(!(await fetch("https://ev-backend-edhm.onrender.com/auth/update-profile-pic",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:r,url:s})})).ok){alert("Failed to update profile picture");return}S(r,s),U(!1)};return e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-100 p-4 cursor-pointer flex justify-between items-center",onClick:h,children:[e.jsxs("div",{className:"relative group w-24 h-24 cursor-pointer",onClick:s=>{s.stopPropagation(),U(!0),O(n.profile_pic_url||"")},children:[e.jsx("img",{src:n.profile_pic_url||J,alt:`${n.username}'s profile`,className:"w-full h-full object-cover rounded-full border shadow"}),e.jsx("div",{className:"absolute inset-0 bg-black/60 hidden group-hover:flex justify-center items-center rounded-full",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"white",className:"size-6",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"})})})]}),R&&e.jsxs("div",{className:"flex flex-col gap-2 mt-2",children:[e.jsx("input",{type:"text",className:"border p-1 rounded",placeholder:"Enter image URL",value:A,onChange:s=>O(s.target.value)}),e.jsxs("div",{className:"flex flex-wrap justify-center gap-4",children:[e.jsx("button",{onClick:s=>{s.stopPropagation(),t(A,n.user_id)},className:"bg-blue-500 text-white px-2 py-1 rounded cursor-pointer hover:bg-blue-700",children:"Save"}),e.jsx("button",{onClick:s=>{s.stopPropagation(),U(!1),O("")},className:"text-gray-500 underline cursor-pointer hover:text-gray-700",children:"Cancel"}),n.profile_pic_url&&e.jsx("button",{onClick:s=>{s.stopPropagation(),O(""),t("",n.user_id)},className:"text-red-500 underline cursor-pointer hover:text-red-700",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"size-6",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"})})})]})]}),e.jsx("h2",{className:"text-xl font-semibold",children:n.username}),e.jsx("span",{children:a?"▲":"▼"})]}),a&&e.jsxs("div",{className:"p-4 bg-white",children:[e.jsx("input",{type:"text",placeholder:"Search topics...",className:"border px-2 py-1 mb-2 rounded w-full",value:E,onChange:s=>V(s.target.value)}),e.jsxs("label",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"checkbox",checked:N[n.user_id]||!1,onChange:()=>k(n.user_id)}),e.jsx("span",{className:"text-sm",children:"Show only topics with context"})]}),d.filter(s=>{const r=F.find(P=>P.topic_id===s.ID),c=s.ShortTitle.toLowerCase().includes(E.toLowerCase()),i=N[n.user_id]?B(r):!0;return c&&i}).map(s=>e.jsx(Q,{user:n,answer:l.find(r=>r.topic_id===s.ID),topic:s,context:F,openTopics:b,toggleTopicOpen:y,editingContext:m,setEditingContext:f,editedContextFields:g,setEditedContextFields:v,saveContextEdit:o},s.ID))]})]})}function K({topics:n}){const[l,a]=u.useState([]),[h,x]=u.useState([]),[w,d]=u.useState({}),[b,y]=u.useState(null),[m,f]=u.useState({}),[g,v]=u.useState({}),[o,N]=u.useState([]),[k,S]=u.useState(!1),[E,V]=u.useState({}),[R,U]=u.useState({}),A=async t=>{if(h.includes(t)){x(s=>s.filter(r=>r!==t));return}try{const s=n.map(i=>i.ID),r=await fetch("https://ev-backend-edhm.onrender.com/compass/compare",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t,ids:s})});if(!r.ok)throw new Error("Failed to fetch answers");const c=await r.json();U(i=>({...i,[t]:c})),x(i=>[...i,t])}catch(s){console.error("Error fetching answers:",s)}},O=t=>{N(s=>s.includes(t)?s.filter(r=>r!==t):[...s,t])},F=t=>{v(s=>({...s,[t]:!s[t]}))},B=async(t,s,r)=>{var _,H,M;const c=(_=m[t])==null?void 0:_[s];if(!c)return;const i=((H=w[t])==null?void 0:H.find(L=>L.topic_id===s))||{},P=c.reasoning!==void 0?c.reasoning:i.reasoning||"",C=(c.sources??((M=i.sources)==null?void 0:M.join(`
`))??"").split(`
`).map(L=>L.trim()).filter(L=>L.length>0),D=r??c.value;try{if(!(await fetch("https://ev-backend-edhm.onrender.com/compass/context",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t,topic_id:s,reasoning:P,sources:C})})).ok)throw new Error("Failed to save context");await fetch("https://ev-backend-edhm.onrender.com/compass/answers/admin",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t,topic_id:s,value:D})}),d(T=>{const j=T[t]||[],I=j.map(p=>p.topic_id===s?{...p,reasoning:P,sources:C}:p),$=j.some(p=>p.topic_id===s)?I:[...j,{topic_id:s,reasoning:P,sources:C}];return{...T,[t]:$}}),U(T=>{const j=T[t]||[],I=j.map(p=>p.topic_id===s?{...p,value:D}:p),$=j.some(p=>p.topic_id===s)?I:[...j,{topic_id:s,value:D}];return{...T,[t]:$}}),f(T=>{var I;const j={...T};return(I=j[t])==null||delete I[s],j}),y(null)}catch(L){console.error(L),alert("Failed to save context or answers")}};return u.useEffect(()=>{(async()=>{try{const[s,r]=await Promise.all([fetch("https://ev-backend-edhm.onrender.com/auth/empowered-accounts",{credentials:"include"}),fetch("https://ev-backend-edhm.onrender.com/compass/context",{credentials:"include"})]);if(!s.ok||!r.ok)throw new Error("Fetch failed");const[c,i]=await Promise.all([s.json(),r.json()]);console.log(i);const P=i.reduce((C,D)=>{const _=D.UserID;return C[_]||(C[_]=[]),C[_].push(D),C},{});a(c),d(P)}catch(s){console.error(s),alert("Failed to load admin data")}})()},[]),e.jsxs("div",{className:"w-3/4 mx-auto mt-6 space-y-4",children:[e.jsx("div",{className:"flex flex-col items-center gap-4",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Empowered Users"})}),l.map(t=>e.jsx(q,{user:t,answers:R[t.user_id]||[],isOpen:h.includes(t.user_id),toggleOpen:()=>A(t.user_id),context:w,setContext:d,topics:n,openTopics:o,toggleTopicOpen:O,editingContext:b,setEditingContext:y,editedContextFields:m,setEditedContextFields:f,saveContextEdit:B,visibleOnlyWithContext:g,toggleVisibleOnlyWithContext:F,updateUserPic:(s,r)=>{a(c=>c.map(i=>i.user_id===s?{...i,profile_pic_url:r}:i))},searchQuery:E[t.user_id]||"",setSearchQuery:s=>V(r=>({...r,[t.user_id]:s}))},t.user_id))]})}export{K as default};
