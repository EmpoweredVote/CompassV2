import{j as e,r as N}from"./index-B3GrGI8u.js";function L({userID:o,topicID:n,existingContext:r,editedContextFields:x,setEditedContextFields:m,cancelEdit:a,saveEdit:i}){var f,d;const g=((f=x[o])==null?void 0:f[n])||{reasoning:(r==null?void 0:r.reasoning)||"",sources:((d=r==null?void 0:r.sources)==null?void 0:d.join(`
`))||""},p=(l,j)=>{m(h=>{var b;return{...h,[o]:{...h[o],[n]:{...(b=h[o])==null?void 0:b[n],[l]:j}}}})};return e.jsxs("div",{className:"flex flex-col gap-4 mt-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Reasoning:"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",rows:4,value:g.reasoning,onChange:l=>p("reasoning",l.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Sources (one per line):"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",rows:4,value:g.sources,onChange:l=>p("sources",l.target.value)})]}),e.jsxs("div",{className:"flex gap-3 mt-2",children:[e.jsx("button",{className:"border px-4 py-2 rounded hover:bg-gray-100",onClick:a,children:"Cancel"}),e.jsx("button",{className:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",onClick:i,children:"Save"})]})]})}function R(o){var r;const n=o.context;if(n)return e.jsxs("div",{className:"flex flex-col gap-4 bg-white p-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Reasoning:"}),n.reasoning?e.jsx("div",{className:"whitespace-pre-wrap text-base leading-relaxed ml-1",children:n.reasoning}):e.jsx("p",{className:"ml-1 italic text-gray-400",children:"No reasoning provided."})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Sources:"}),(r=n.sources)!=null&&r.length?e.jsx("ul",{className:"list-disc list-inside ml-1",children:n.sources.map((x,m)=>e.jsx("li",{children:x},m))}):e.jsx("p",{className:"ml-1 italic text-gray-400",children:"No sources provided."})]})]})}function P({user:o,topic:n,context:r,openTopics:x,toggleTopicOpen:m,editingContext:a,setEditingContext:i,editedContextFields:g,setEditedContextFields:p,saveContextEdit:f}){const d=x.includes(n.ID),l=(a==null?void 0:a.user_id)===o.user_id&&(a==null?void 0:a.topic_id)===n.ID,j=r.find(y=>y.topic_id===n.ID),h=()=>{m(n.ID)},b=()=>{i({user_id:o.user_id,topic_id:n.ID}),d||m(n.ID)};return e.jsxs("div",{className:"border rounded mt-2 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between cursor-pointer bg-gray-100 p-4",children:[e.jsx("h3",{onClick:h,className:"font-semibold w-full h-full",children:n.ShortTitle}),e.jsx("button",{onClick:b,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-600 hover:text-black cursor-pointer",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931ZM19.5 7.125 16.862 4.487ZM18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"})})})]}),d&&e.jsxs("div",{className:"mt-2",children:[l?e.jsx(L,{userID:o.user_id,topicID:n.ID,existingContext:j,editedContextFields:g,setEditedContextFields:p,cancelEdit:()=>i(null),saveEdit:()=>f(o.user_id,n.ID)}):e.jsx(R,{context:j}),!j&&!l&&e.jsx("p",{className:"italic text-gray-400 mt-2 ml-1 p-2",children:"No context written for this topic."})]})]})}function V({user:o,isOpen:n,toggleOpen:r,context:x,setContext:m,topics:a,openTopics:i,toggleTopicOpen:g,editingContext:p,setEditingContext:f,editedContextFields:d,setEditedContextFields:l,saveContextEdit:j,visibleOnlyWithContext:h,toggleVisibleOnlyWithContext:b}){const y=x[o.user_id]||[],I=u=>{var k,s;return u&&(((k=u.reasoning)==null?void 0:k.trim())||((s=u.sources)==null?void 0:s.length)>0)};return e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-100 p-4 cursor-pointer flex justify-between items-center",onClick:r,children:[e.jsx("h2",{className:"text-xl font-semibold",children:o.username}),e.jsx("span",{children:n?"▲":"▼"})]}),n&&e.jsxs("div",{className:"p-4 bg-white",children:[e.jsxs("label",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"checkbox",checked:h[o.user_id]||!1,onChange:()=>b(o.user_id)}),e.jsx("span",{className:"text-sm",children:"Show only topics with context"})]}),a.filter(u=>{const k=y.find(s=>s.topic_id===u.ID);return h[o.user_id]?I(k):!0}).map(u=>e.jsx(P,{user:o,topic:u,context:y,openTopics:i,toggleTopicOpen:g,editingContext:p,setEditingContext:f,editedContextFields:d,setEditedContextFields:l,saveContextEdit:j},u.ID))]})]})}function H({topics:o}){const[n,r]=N.useState([]),[x,m]=N.useState([]),[a,i]=N.useState({}),[g,p]=N.useState(null),[f,d]=N.useState({}),[l,j]=N.useState({}),[h,b]=N.useState([]),y=s=>{m(t=>t.includes(s)?t.filter(c=>c!==s):[...t,s])},I=s=>{b(t=>t.includes(s)?t.filter(c=>c!==s):[...t,s])},u=s=>{j(t=>({...t,[s]:!t[s]}))},k=async(s,t)=>{var v,A,S;const c=(v=f[s])==null?void 0:v[t];if(!c)return;const O=((A=a[s])==null?void 0:A.find(w=>w.topic_id===t))||{},E=c.reasoning!==void 0?c.reasoning:O.reasoning||"",C=(c.sources??((S=O.sources)==null?void 0:S.join(`
`))??"").split(`
`).map(w=>w.trim()).filter(w=>w.length>0);try{if(!(await fetch("https://ev-backend-edhm.onrender.com/compass/context",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:s,topic_id:t,reasoning:E,sources:C})})).ok)throw new Error("Failed to save context");i(T=>{const D=T[s]||[],U=D.map(F=>F.topic_id===t?{...F,reasoning:E,sources:C}:F),_=D.some(F=>F.topic_id===t)?U:[...D,{topic_id:t,reasoning:E,sources:C}];return{...T,[s]:_}}),d(T=>{var U;const D={...T};return(U=D[s])==null||delete U[t],D}),p(null)}catch(w){console.error(w),alert("Failed to save context")}};return N.useEffect(()=>{(async()=>{try{const[t,c]=await Promise.all([fetch("https://ev-backend-edhm.onrender.com/auth/empowered-accounts",{credentials:"include"}),fetch("https://ev-backend-edhm.onrender.com/compass/context",{credentials:"include"})]);if(!t.ok||!c.ok)throw new Error("Fetch failed");const[O,E]=await Promise.all([t.json(),c.json()]);console.log(E);const C=E.reduce((v,A)=>{const S=A.UserID;return v[S]||(v[S]=[]),v[S].push(A),v},{});r(O),i(C)}catch(t){console.error(t),alert("Failed to load admin data")}})()},[]),e.jsxs("div",{className:"w-3/4 mx-auto mt-6 space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-center",children:"Empowered Users"}),n.map(s=>e.jsx(V,{user:s,isOpen:x.includes(s.user_id),toggleOpen:()=>y(s.user_id),context:a,setContext:i,topics:o,openTopics:h,toggleTopicOpen:I,editingContext:g,setEditingContext:p,editedContextFields:f,setEditedContextFields:d,saveContextEdit:k,visibleOnlyWithContext:l,toggleVisibleOnlyWithContext:u},s.user_id))]})}export{H as default};
