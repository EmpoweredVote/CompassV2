import{j as e,r as x}from"./index-YfVBpsc2.js";function H({userID:a,topicID:l,existingContext:t,existingAnswer:i,topic:p,editedContextFields:b,setEditedContextFields:c,cancelEdit:N,saveEdit:S}){var v,g;const h=((v=b[a])==null?void 0:v[l])||{reasoning:(t==null?void 0:t.reasoning)||"",sources:((g=t==null?void 0:t.sources)==null?void 0:g.join(`
`))||"",value:(i==null?void 0:i.value)??null},f=(r,k)=>{c(E=>{var y;return{...E,[a]:{...E[a],[l]:{...(y=E[a])==null?void 0:y[l],[r]:k}}}})};return e.jsxs("div",{className:"flex flex-col gap-4 mt-2 mx-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Stance Selection:"}),e.jsxs("select",{className:"border px-2 py-1 rounded w-full",value:h.value??"",onChange:r=>f("value",parseInt(r.target.value)),children:[e.jsx("option",{value:"",disabled:!0,children:"Select a stance"}),(p.stances||[]).map(r=>e.jsxs("option",{value:r.Value,children:[r.Value,". ",r.Text]},r.Value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Reasoning:"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",rows:4,value:h.reasoning,onChange:r=>f("reasoning",r.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Sources (one per line):"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",rows:4,value:h.sources,onChange:r=>f("sources",r.target.value)})]}),e.jsxs("div",{className:"flex justify-center gap-3 my-2",children:[e.jsx("button",{className:"border px-4 py-2 rounded hover:bg-gray-100",onClick:N,children:"Cancel"}),e.jsx("button",{className:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",onClick:()=>S(h.value),children:"Save"})]})]})}function Z(a){var t;const l=a.context;if(l)return e.jsxs("div",{className:"flex flex-col gap-4 bg-white p-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Reasoning:"}),l.reasoning?e.jsx("div",{className:"whitespace-pre-wrap text-base leading-relaxed ml-1",children:l.reasoning}):e.jsx("p",{className:"ml-1 italic text-gray-400",children:"No reasoning provided."})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Sources:"}),(t=l.sources)!=null&&t.length?e.jsx("ul",{className:"list-disc list-inside ml-1",children:l.sources.map((i,p)=>e.jsx("li",{children:i},p))}):e.jsx("p",{className:"ml-1 italic text-gray-400",children:"No sources provided."})]})]})}function Q({user:a,answer:l,topic:t,context:i,openTopics:p,toggleTopicOpen:b,editingContext:c,setEditingContext:N,editedContextFields:S,setEditedContextFields:h,saveContextEdit:f}){var y;const v=p.includes(t.ID),g=(c==null?void 0:c.user_id)===a.user_id&&(c==null?void 0:c.topic_id)===t.ID,r=i.find(O=>O.topic_id===t.ID),k=()=>{b(t.ID)},E=()=>{N({user_id:a.user_id,topic_id:t.ID}),v||b(t.ID)};return e.jsxs("div",{className:"border rounded mt-2 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between cursor-pointer bg-gray-100 p-4",children:[e.jsx("h3",{onClick:k,className:"font-semibold w-full h-full",children:t.ShortTitle}),e.jsx("button",{onClick:E,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-600 hover:text-black cursor-pointer",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931ZM19.5 7.125 16.862 4.487ZM18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"})})})]}),v&&e.jsxs("div",{className:"mt-2",children:[g?e.jsx(H,{userID:a.user_id,topicID:t.ID,topic:t,existingContext:r,editedContextFields:S,setEditedContextFields:h,cancelEdit:()=>N(null),saveEdit:()=>f(a.user_id,t.ID)}):e.jsxs("div",{children:[l&&e.jsxs("div",{className:"m-2 bg-gray-100 p-4 rounded",children:[e.jsxs("p",{className:"font-semibold",children:["Answer Value: ",l.value]}),e.jsx("p",{className:"text-gray-700",children:((y=t.stances.find(O=>O.Value===l.value))==null?void 0:y.Text)||e.jsx("span",{className:"italic text-gray-400",children:"Unknown stance"})})]}),e.jsx(Z,{context:r})]}),!r&&!g&&e.jsx("p",{className:"italic text-gray-400 mt-2 ml-1 p-2",children:"No context written for this topic."})]})]})}function q({user:a,answers:l,isOpen:t,toggleOpen:i,context:p,setContext:b,topics:c,openTopics:N,toggleTopicOpen:S,editingContext:h,setEditingContext:f,editedContextFields:v,setEditedContextFields:g,saveContextEdit:r,visibleOnlyWithContext:k,toggleVisibleOnlyWithContext:E,searchQuery:y,setSearchQuery:O}){const P=p[a.user_id]||[],B=o=>{var D,I;return o&&(((D=o.reasoning)==null?void 0:D.trim())||((I=o.sources)==null?void 0:I.length)>0)};return e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-100 p-4 cursor-pointer flex justify-between items-center",onClick:i,children:[e.jsx("h2",{className:"text-xl font-semibold",children:a.username}),e.jsx("span",{children:t?"â–²":"â–¼"})]}),t&&e.jsxs("div",{className:"p-4 bg-white",children:[e.jsx("input",{type:"text",placeholder:"Search topics...",className:"border px-2 py-1 mb-2 rounded w-full",value:y,onChange:o=>O(o.target.value)}),e.jsxs("label",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"checkbox",checked:k[a.user_id]||!1,onChange:()=>E(a.user_id)}),e.jsx("span",{className:"text-sm",children:"Show only topics with context"})]}),c.filter(o=>{const D=P.find($=>$.topic_id===o.ID),I=o.ShortTitle.toLowerCase().includes(y.toLowerCase()),R=k[a.user_id]?B(D):!0;return I&&R}).map(o=>e.jsx(Q,{user:a,answer:l.find(D=>D.topic_id===o.ID),topic:o,context:P,openTopics:N,toggleTopicOpen:S,editingContext:h,setEditingContext:f,editedContextFields:v,setEditedContextFields:g,saveContextEdit:r},o.ID))]})]})}function G({topics:a}){const[l,t]=x.useState([]),[i,p]=x.useState([]),[b,c]=x.useState({}),[N,S]=x.useState(null),[h,f]=x.useState({}),[v,g]=x.useState({}),[r,k]=x.useState([]),[E,y]=x.useState(!1),[O,P]=x.useState({}),[B,o]=x.useState({}),D=async s=>{if(i.includes(s)){p(n=>n.filter(d=>d!==s));return}try{const n=a.map(u=>u.ID),d=await fetch("https://ev-backend-edhm.onrender.com/compass/compare",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:s,ids:n})});if(!d.ok)throw new Error("Failed to fetch answers");const w=await d.json();o(u=>({...u,[s]:w})),p(u=>[...u,s])}catch(n){console.error("Error fetching answers:",n)}},I=s=>{k(n=>n.includes(s)?n.filter(d=>d!==s):[...n,s])},R=s=>{g(n=>({...n,[s]:!n[s]}))},$=async(s,n,d)=>{var L,J,W;const w=(L=h[s])==null?void 0:L[n];if(!w)return;const u=((J=b[s])==null?void 0:J.find(T=>T.topic_id===n))||{},A=w.reasoning!==void 0?w.reasoning:u.reasoning||"",C=(w.sources??((W=u.sources)==null?void 0:W.join(`
`))??"").split(`
`).map(T=>T.trim()).filter(T=>T.length>0),F=d??w.value;try{if(!(await fetch("https://ev-backend-edhm.onrender.com/compass/context",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:s,topic_id:n,reasoning:A,sources:C})})).ok)throw new Error("Failed to save context");await fetch("https://ev-backend-edhm.onrender.com/compass/answers/admin",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:s,topic_id:n,value:F})}),c(U=>{const j=U[s]||[],V=j.map(m=>m.topic_id===n?{...m,reasoning:A,sources:C}:m),M=j.some(m=>m.topic_id===n)?V:[...j,{topic_id:n,reasoning:A,sources:C}];return{...U,[s]:M}}),o(U=>{const j=U[s]||[],V=j.map(m=>m.topic_id===n?{...m,value:F}:m),M=j.some(m=>m.topic_id===n)?V:[...j,{topic_id:n,value:F}];return{...U,[s]:M}}),f(U=>{var V;const j={...U};return(V=j[s])==null||delete V[n],j}),S(null)}catch(T){console.error(T),alert("Failed to save context or answers")}};return x.useEffect(()=>{(async()=>{try{const[n,d]=await Promise.all([fetch("https://ev-backend-edhm.onrender.com/auth/empowered-accounts",{credentials:"include"}),fetch("https://ev-backend-edhm.onrender.com/compass/context",{credentials:"include"})]);if(!n.ok||!d.ok)throw new Error("Fetch failed");const[w,u]=await Promise.all([n.json(),d.json()]);console.log(u);const A=u.reduce((C,F)=>{const L=F.UserID;return C[L]||(C[L]=[]),C[L].push(F),C},{});t(w),c(A)}catch(n){console.error(n),alert("Failed to load admin data")}})()},[]),e.jsxs("div",{className:"w-3/4 mx-auto mt-6 space-y-4",children:[e.jsx("div",{className:"flex flex-col items-center gap-4",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Empowered Users"})}),l.map(s=>e.jsx(q,{user:s,answers:B[s.user_id]||[],isOpen:i.includes(s.user_id),toggleOpen:()=>D(s.user_id),context:b,setContext:c,topics:a,openTopics:r,toggleTopicOpen:I,editingContext:N,setEditingContext:S,editedContextFields:h,setEditedContextFields:f,saveContextEdit:$,visibleOnlyWithContext:v,toggleVisibleOnlyWithContext:R,searchQuery:O[s.user_id]||"",setSearchQuery:n=>P(d=>({...d,[s.user_id]:n}))},s.user_id))]})}export{G as default};
