import{j as e,r as d,p as H}from"./index-_keHT-pP.js";function Z({userID:n,topicID:o,existingContext:a,existingAnswer:u,topic:p,editedContextFields:y,setEditedContextFields:c,cancelEdit:w,saveEdit:N}){var g,v;const h=((g=y[n])==null?void 0:g[o])||{reasoning:(a==null?void 0:a.reasoning)||"",sources:((v=a==null?void 0:a.sources)==null?void 0:v.join(`
`))||"",value:(u==null?void 0:u.value)??null},f=(l,S)=>{c(k=>{var b;return{...k,[n]:{...k[n],[o]:{...(b=k[n])==null?void 0:b[o],[l]:S}}}})};return e.jsxs("div",{className:"flex flex-col gap-4 mt-2 mx-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Stance Selection:"}),e.jsxs("select",{className:"border px-2 py-1 rounded w-full",value:h.value??"",onChange:l=>f("value",parseInt(l.target.value)),children:[e.jsx("option",{value:"",disabled:!0,children:"Select a stance"}),(p.stances||[]).map(l=>e.jsxs("option",{value:l.Value,children:[l.Value,". ",l.Text]},l.Value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Reasoning:"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",rows:4,value:h.reasoning,onChange:l=>f("reasoning",l.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold",children:"Sources (one per line):"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",rows:4,value:h.sources,onChange:l=>f("sources",l.target.value)})]}),e.jsxs("div",{className:"flex justify-center gap-3 my-2",children:[e.jsx("button",{className:"border px-4 py-2 rounded hover:bg-gray-100",onClick:w,children:"Cancel"}),e.jsx("button",{className:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",onClick:()=>N(h.value),children:"Save"})]})]})}function Q(n){var a;const o=n.context;if(o)return e.jsxs("div",{className:"flex flex-col gap-4 bg-white p-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Reasoning:"}),o.reasoning?e.jsx("div",{className:"whitespace-pre-wrap text-base leading-relaxed ml-1",children:o.reasoning}):e.jsx("p",{className:"ml-1 italic text-gray-400",children:"No reasoning provided."})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Sources:"}),(a=o.sources)!=null&&a.length?e.jsx("ul",{className:"list-disc list-inside ml-1",children:o.sources.map((u,p)=>e.jsx("li",{children:u},p))}):e.jsx("p",{className:"ml-1 italic text-gray-400",children:"No sources provided."})]})]})}function q({user:n,answer:o,topic:a,context:u,openTopics:p,toggleTopicOpen:y,editingContext:c,setEditingContext:w,editedContextFields:N,setEditedContextFields:h,saveContextEdit:f}){var b;const g=p.includes(a.ID),v=(c==null?void 0:c.user_id)===n.user_id&&(c==null?void 0:c.topic_id)===a.ID,l=u.find(T=>T.topic_id===a.ID),S=()=>{y(a.ID)},k=()=>{w({user_id:n.user_id,topic_id:a.ID}),g||y(a.ID)};return e.jsxs("div",{className:"border rounded mt-2 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between cursor-pointer bg-gray-100 p-4",children:[e.jsx("h3",{onClick:S,className:"font-semibold w-full h-full",children:a.ShortTitle}),e.jsx("button",{onClick:k,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-600 hover:text-black cursor-pointer",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931ZM19.5 7.125 16.862 4.487ZM18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"})})})]}),g&&e.jsxs("div",{className:"mt-2",children:[v?e.jsx(Z,{userID:n.user_id,topicID:a.ID,topic:a,existingContext:l,editedContextFields:N,setEditedContextFields:h,cancelEdit:()=>w(null),saveEdit:()=>f(n.user_id,a.ID)}):e.jsxs("div",{children:[o&&e.jsxs("div",{className:"m-2 bg-gray-100 p-4 rounded",children:[e.jsxs("p",{className:"font-semibold",children:["Answer Value: ",o.value]}),e.jsx("p",{className:"text-gray-700",children:((b=a.stances.find(T=>T.Value===o.value))==null?void 0:b.Text)||e.jsx("span",{className:"italic text-gray-400",children:"Unknown stance"})})]}),e.jsx(Q,{context:l})]}),!l&&!v&&e.jsx("p",{className:"italic text-gray-400 mt-2 ml-1 p-2",children:"No context written for this topic."})]})]})}function z({user:n,answers:o,isOpen:a,toggleOpen:u,context:p,setContext:y,topics:c,openTopics:w,toggleTopicOpen:N,editingContext:h,setEditingContext:f,editedContextFields:g,setEditedContextFields:v,saveContextEdit:l,visibleOnlyWithContext:S,toggleVisibleOnlyWithContext:k,searchQuery:b,setSearchQuery:T}){const[V,P]=d.useState(!1),[L,_]=d.useState(""),R=p[n.user_id]||[],A=s=>{var t,r;return s&&(((t=s.reasoning)==null?void 0:t.trim())||((r=s.sources)==null?void 0:r.length)>0)},$=async s=>{if(!(await fetch("https://ev-backend-edhm.onrender.com/auth/update-profile-pic",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:s,url:L})})).ok){alert("Failed to update profile picture");return}P(!1)};return e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-100 p-4 cursor-pointer flex justify-between items-center",onClick:u,children:[e.jsx("img",{src:n.profile_pic_url||H,alt:`${n.username}'s profile`,className:"w-20 h-20 object-cover rounded-full border shadow"}),V?e.jsxs("div",{className:"flex flex-col gap-2 mt-2",children:[e.jsx("input",{type:"text",className:"border p-1 rounded",placeholder:"Enter image URL",value:L,onChange:s=>_(s.target.value)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>$(n.user_id),className:"bg-blue-500 text-white px-2 py-1 rounded",children:"Save"}),e.jsx("button",{onClick:()=>{P(!1),_("")},className:"text-gray-500 underline",children:"Cancel"})]})]}):e.jsx("button",{onClick:()=>{P(!0),_(n.profile_pic_url||"")},className:"text-blue-600 underline text-sm mt-2",children:n.profile_pic_url?"Edit Profile Image":"Add Profile Image"}),e.jsx("h2",{className:"text-xl font-semibold",children:n.username}),e.jsx("span",{children:a?"▲":"▼"})]}),a&&e.jsxs("div",{className:"p-4 bg-white",children:[e.jsx("input",{type:"text",placeholder:"Search topics...",className:"border px-2 py-1 mb-2 rounded w-full",value:b,onChange:s=>T(s.target.value)}),e.jsxs("label",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"checkbox",checked:S[n.user_id]||!1,onChange:()=>k(n.user_id)}),e.jsx("span",{className:"text-sm",children:"Show only topics with context"})]}),c.filter(s=>{const t=R.find(i=>i.topic_id===s.ID),r=s.ShortTitle.toLowerCase().includes(b.toLowerCase()),m=S[n.user_id]?A(t):!0;return r&&m}).map(s=>e.jsx(q,{user:n,answer:o.find(t=>t.topic_id===s.ID),topic:s,context:R,openTopics:w,toggleTopicOpen:N,editingContext:h,setEditingContext:f,editedContextFields:g,setEditedContextFields:v,saveContextEdit:l},s.ID))]})]})}function K({topics:n}){const[o,a]=d.useState([]),[u,p]=d.useState([]),[y,c]=d.useState({}),[w,N]=d.useState(null),[h,f]=d.useState({}),[g,v]=d.useState({}),[l,S]=d.useState([]),[k,b]=d.useState(!1),[T,V]=d.useState({}),[P,L]=d.useState({}),_=async s=>{if(u.includes(s)){p(t=>t.filter(r=>r!==s));return}try{const t=n.map(i=>i.ID),r=await fetch("https://ev-backend-edhm.onrender.com/compass/compare",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:s,ids:t})});if(!r.ok)throw new Error("Failed to fetch answers");const m=await r.json();L(i=>({...i,[s]:m})),p(i=>[...i,s])}catch(t){console.error("Error fetching answers:",t)}},R=s=>{S(t=>t.includes(s)?t.filter(r=>r!==s):[...t,s])},A=s=>{v(t=>({...t,[s]:!t[s]}))},$=async(s,t,r)=>{var U,J,M;const m=(U=h[s])==null?void 0:U[t];if(!m)return;const i=((J=y[s])==null?void 0:J.find(C=>C.topic_id===t))||{},F=m.reasoning!==void 0?m.reasoning:i.reasoning||"",E=(m.sources??((M=i.sources)==null?void 0:M.join(`
`))??"").split(`
`).map(C=>C.trim()).filter(C=>C.length>0),O=r??m.value;try{if(!(await fetch("https://ev-backend-edhm.onrender.com/compass/context",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:s,topic_id:t,reasoning:F,sources:E})})).ok)throw new Error("Failed to save context");await fetch("https://ev-backend-edhm.onrender.com/compass/answers/admin",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:s,topic_id:t,value:O})}),c(D=>{const j=D[s]||[],I=j.map(x=>x.topic_id===t?{...x,reasoning:F,sources:E}:x),B=j.some(x=>x.topic_id===t)?I:[...j,{topic_id:t,reasoning:F,sources:E}];return{...D,[s]:B}}),L(D=>{const j=D[s]||[],I=j.map(x=>x.topic_id===t?{...x,value:O}:x),B=j.some(x=>x.topic_id===t)?I:[...j,{topic_id:t,value:O}];return{...D,[s]:B}}),f(D=>{var I;const j={...D};return(I=j[s])==null||delete I[t],j}),N(null)}catch(C){console.error(C),alert("Failed to save context or answers")}};return d.useEffect(()=>{(async()=>{try{const[t,r]=await Promise.all([fetch("https://ev-backend-edhm.onrender.com/auth/empowered-accounts",{credentials:"include"}),fetch("https://ev-backend-edhm.onrender.com/compass/context",{credentials:"include"})]);if(!t.ok||!r.ok)throw new Error("Fetch failed");const[m,i]=await Promise.all([t.json(),r.json()]);console.log(i);const F=i.reduce((E,O)=>{const U=O.UserID;return E[U]||(E[U]=[]),E[U].push(O),E},{});a(m),c(F)}catch(t){console.error(t),alert("Failed to load admin data")}})()},[]),e.jsxs("div",{className:"w-3/4 mx-auto mt-6 space-y-4",children:[e.jsx("div",{className:"flex flex-col items-center gap-4",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Empowered Users"})}),o.map(s=>e.jsx(z,{user:s,answers:P[s.user_id]||[],isOpen:u.includes(s.user_id),toggleOpen:()=>_(s.user_id),context:y,setContext:c,topics:n,openTopics:l,toggleTopicOpen:R,editingContext:w,setEditingContext:N,editedContextFields:h,setEditedContextFields:f,saveContextEdit:$,visibleOnlyWithContext:g,toggleVisibleOnlyWithContext:A,searchQuery:T[s.user_id]||"",setSearchQuery:t=>V(r=>({...r,[s.user_id]:t}))},s.user_id))]})}export{K as default};
